---
phase: 01-core-cli-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types.ts
  - src/utils/command.ts
  - src/session/storage.ts
  - src/__tests__/session.test.ts
  - src/__tests__/resume-functionality.test.ts
  - src/__tests__/context-building.test.ts
autonomous: true
requirements: [CLEAN-01, CLEAN-02, TEST-02]

must_haves:
  truths:
    - "src/session/ directory and storage.ts are gone — no remaining Codex session imports anywhere in the codebase"
    - "src/types.ts exports the new TOOLS enum (ask, suggest, explain, ping), new Zod schemas, and Copilot model constants"
    - "src/utils/command.ts accepts an optional options.strictExitCode flag with backward-compatible default"
    - "The three deleted test files are gone and npm run build succeeds with no import errors"
  artifacts:
    - path: "src/types.ts"
      provides: "TOOLS enum, AskToolSchema, SuggestToolSchema, ExplainToolSchema, PingToolSchema, DEFAULT_COPILOT_MODEL, COPILOT_DEFAULT_MODEL_ENV_VAR"
      contains: "const TOOLS = { ASK: 'ask', SUGGEST: 'suggest', EXPLAIN: 'explain', PING: 'ping' }"
    - path: "src/utils/command.ts"
      provides: "executeCommand with optional strictExitCode option"
      contains: "ExecuteCommandOptions"
  key_links:
    - from: "src/utils/command.ts"
      to: "resolve/reject logic in close handler"
      via: "options.strictExitCode branch"
      pattern: "strictExitCode"
    - from: "src/types.ts"
      to: "TOOLS constant"
      via: "named export"
      pattern: "export const TOOLS"
---

<objective>
Delete the Codex session management layer and rewrite the type foundation. This plan establishes the clean base that all subsequent plans depend on: no session imports, new TOOLS enum, new Zod schemas for the four Copilot tools, new model constants, and a backward-compatible strictExitCode option in the command execution utility.

Purpose: Eliminate the session layer before any handler code is touched so no dangling imports survive into Plan 02. Rewriting types.ts first ensures handlers.ts can immediately import the correct schemas and constants.
Output: Deleted session files, rewritten types.ts, updated command.ts, deleted session test files.
</objective>

<execution_context>
@/Users/jonathanborduas/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jonathanborduas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-cli-integration/01-RESEARCH.md
@src/types.ts
@src/utils/command.ts
@src/session/storage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete session layer and session test files</name>
  <files>
    src/session/storage.ts
    src/__tests__/session.test.ts
    src/__tests__/resume-functionality.test.ts
    src/__tests__/context-building.test.ts
  </files>
  <action>
    Delete the following files and directory:
    - `src/session/storage.ts` — the InMemorySessionStorage implementation
    - `src/session/` — the directory itself (after storage.ts is removed, it should be empty)
    - `src/__tests__/session.test.ts` — tests for the deleted session storage
    - `src/__tests__/resume-functionality.test.ts` — tests for Codex session resume
    - `src/__tests__/context-building.test.ts` — tests for Codex context building

    After deleting, verify no other source file imports from `../session/storage.js` or `./session/storage.js`. Run: `grep -r "session/storage" src/ --include="*.ts"` — should return zero results. If any file still imports from session storage, remove those import lines now (they'll be dead imports since handlers.ts is being fully rewritten in the next plan).

    Do NOT modify handlers.ts yet — it will still reference session storage but it will be fully replaced in Plan 02. The build will temporarily be broken after this step; that is acceptable because Plan 02 fixes it immediately.

    Use shell commands to delete: `rm -f src/session/storage.ts && rmdir src/session/ && rm -f src/__tests__/session.test.ts src/__tests__/resume-functionality.test.ts src/__tests__/context-building.test.ts`
  </action>
  <verify>
    `ls src/session/ 2>&1` should return "No such file or directory"
    `ls src/__tests__/` should NOT contain session.test.ts, resume-functionality.test.ts, or context-building.test.ts
    `grep -r "session/storage" src/ --include="*.ts"` should return zero results
  </verify>
  <done>Session directory and the three test files are deleted; no remaining imports from session/storage anywhere in src/</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite src/types.ts with Copilot types and schemas</name>
  <files>src/types.ts</files>
  <action>
    Fully rewrite `src/types.ts`. The file must:

    **REMOVE (delete entirely):**
    - `CodexToolSchema`, `ReviewToolSchema`, `HelpToolSchema`, `ListSessionsToolSchema` — all Codex-specific schemas
    - `SandboxMode` Zod enum
    - `AVAILABLE_CODEX_MODELS`, `getModelDescription` — Codex model helpers
    - `DEFAULT_CODEX_MODEL`, `CODEX_DEFAULT_MODEL_ENV_VAR` constants

    **KEEP (preserve exactly):**
    - `ToolResult` type
    - `ToolDefinition` interface
    - `ToolAnnotations` interface
    - `ServerConfig` interface
    - `CommandResult` type (`{ stdout: string; stderr: string }`)
    - `ToolHandlerContext` interface (with `progressToken?` and `sendProgress`)
    - `ProgressToken` type

    **ADD:**
    ```typescript
    import { z } from 'zod';

    export const TOOLS = {
      ASK: 'ask',
      SUGGEST: 'suggest',
      EXPLAIN: 'explain',
      PING: 'ping',
    } as const;

    export type ToolName = (typeof TOOLS)[keyof typeof TOOLS];

    export const DEFAULT_COPILOT_MODEL = 'gpt-4.1' as const;
    export const COPILOT_DEFAULT_MODEL_ENV_VAR = 'COPILOT_DEFAULT_MODEL' as const;

    export const AskToolSchema = z.object({
      prompt: z.string(),
      model: z.string().optional(),
      addDir: z.string().optional(),
    });
    export type AskToolArgs = z.infer<typeof AskToolSchema>;

    export const SuggestToolSchema = z.object({
      prompt: z.string(),
      target: z.enum(['shell', 'git', 'gh']).optional(),
      model: z.string().optional(),
      addDir: z.string().optional(),
    });
    export type SuggestToolArgs = z.infer<typeof SuggestToolSchema>;

    export const ExplainToolSchema = z.object({
      command: z.string(),
      model: z.string().optional(),
      addDir: z.string().optional(),
    });
    export type ExplainToolArgs = z.infer<typeof ExplainToolSchema>;

    export const PingToolSchema = z.object({});
    export type PingToolArgs = z.infer<typeof PingToolSchema>;
    ```

    Import order: zod import first (third-party), then keep any MCP SDK imports, then type definitions. Use single quotes, semicolons, 2-space indent (per .prettierrc).

    Do NOT add model enum validation — the copilot CLI validates models with clear errors; per research this is maintenance burden to duplicate.
  </action>
  <verify>
    `npx tsc --noEmit 2>&1 | grep "types.ts"` — should show zero errors for types.ts itself (other files may still error due to deleted session imports in handlers.ts — acceptable).
    `grep "DEFAULT_COPILOT_MODEL\|COPILOT_DEFAULT_MODEL_ENV_VAR\|AskToolSchema\|SuggestToolSchema\|ExplainToolSchema\|PingToolSchema" src/types.ts` — all should be present.
    `grep "DEFAULT_CODEX_MODEL\|AVAILABLE_CODEX_MODELS\|SandboxMode\|CodexToolSchema\|ReviewToolSchema" src/types.ts` — should return zero results.
  </verify>
  <done>types.ts exports the four new schemas, TOOLS enum with ask/suggest/explain/ping, DEFAULT_COPILOT_MODEL='gpt-4.1', and COPILOT_DEFAULT_MODEL_ENV_VAR; all Codex-specific types are removed</done>
</task>

<task type="auto">
  <name>Task 3: Add strictExitCode option to src/utils/command.ts</name>
  <files>src/utils/command.ts</files>
  <action>
    Make a targeted, backward-compatible addition to `src/utils/command.ts`. Do NOT rewrite the file — only add the `strictExitCode` option.

    **Add** the following interface (after existing imports, before `executeCommand`):
    ```typescript
    export interface ExecuteCommandOptions {
      strictExitCode?: boolean;
    }
    ```

    **Update** the `executeCommand` function signature to accept a fourth optional parameter:
    ```typescript
    export async function executeCommand(
      file: string,
      args: string[] = [],
      envOverride?: ProcessEnv,
      options: ExecuteCommandOptions = {}
    ): Promise<CommandResult>
    ```

    **Update** the `child.on('close', (code) => { ... })` handler to branch on `options.strictExitCode`. The existing lenient logic (`code === 0 || stdout || stderr`) must be preserved as the default. When `strictExitCode: true`:
    - If `code === 0`: resolve with `{ stdout, stderr }`
    - If `code !== 0`: reject with `new CommandExecutionError([file, ...args].join(' '), \`Command failed with exit code ${code}: ${stderr || 'no error message'}\`, new Error(stderr || 'Unknown error'))`

    The existing lenient branch (when `strictExitCode` is falsy) must remain exactly as it is — this preserves backward compatibility for any non-Copilot callers.

    Also update the JSDoc on `executeCommand` to mention the new `options` parameter.

    Do NOT touch `executeCommandStreaming` — it is unchanged.
  </action>
  <verify>
    `npx tsc --noEmit 2>&1 | grep "command.ts"` — zero errors for command.ts.
    `grep "ExecuteCommandOptions\|strictExitCode" src/utils/command.ts` — both strings present.
    The existing callers still pass without the fourth argument: `grep "executeCommand(" src/tools/handlers.ts` — existing calls with 3 args are still valid because options defaults to `{}`.
  </verify>
  <done>executeCommand accepts optional ExecuteCommandOptions with strictExitCode; when true only exit code 0 resolves; when false/omitted the existing lenient logic is unchanged</done>
</task>

</tasks>

<verification>
After all three tasks complete:
1. `ls src/session/ 2>&1` → "No such file or directory"
2. `ls src/__tests__/` → does NOT list session.test.ts, resume-functionality.test.ts, context-building.test.ts
3. `grep "DEFAULT_COPILOT_MODEL" src/types.ts` → found
4. `grep "ASK.*ask\|SUGGEST.*suggest\|EXPLAIN.*explain\|PING.*ping" src/types.ts` → found
5. `grep "strictExitCode" src/utils/command.ts` → found
6. `grep "DEFAULT_CODEX_MODEL\|SandboxMode\|CodexToolSchema" src/types.ts` → zero results

Note: `npm run build` will FAIL after this plan because handlers.ts still imports from session/storage. This is expected and will be fixed in Plan 02. `npm test` will also fail for the same reason. Do not attempt to fix it here.
</verification>

<success_criteria>
- Session layer is entirely deleted with no dangling imports in types.ts or command.ts
- types.ts provides the complete type foundation for the four new Copilot tools
- command.ts is backward-compatible with a new strictExitCode path for Copilot handlers
- The three session test files are deleted
- Plan 02 can immediately proceed without any preparatory work
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-cli-integration/01-01-SUMMARY.md` using the summary template. Note which files were deleted and what types.ts now exports. Record that npm build is broken (expected) and will be fixed by Plan 02.
</output>
