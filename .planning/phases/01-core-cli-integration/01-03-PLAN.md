---
phase: 01-core-cli-integration
plan: 03
type: execute
wave: 3
depends_on: [01-02]
files_modified:
  - src/__tests__/index.test.ts
  - src/__tests__/mcp-stdio.test.ts
  - src/__tests__/error-scenarios.test.ts
  - src/__tests__/model-selection.test.ts
  - src/__tests__/default-model.test.ts
  - src/__tests__/edge-cases.test.ts
autonomous: true
requirements: [TEST-01, TEST-04]

must_haves:
  truths:
    - "npm test passes with zero failing tests"
    - "index.test.ts tests ask, suggest, explain, and ping handlers exist and return ToolResult"
    - "mcp-stdio.test.ts verifies --allow-all-tools, --no-ask-user, --silent, --no-color, --no-auto-update are passed in every copilot invocation"
    - "The -p flag is verified in mcp-stdio.test.ts (not -i or --interactive)"
    - "default-model.test.ts verifies DEFAULT_COPILOT_MODEL is gpt-4.1 and COPILOT_DEFAULT_MODEL_ENV_VAR is the override key"
  artifacts:
    - path: "src/__tests__/index.test.ts"
      provides: "Handler existence tests and MCP schema compliance tests for 4 tools"
      contains: "AskToolHandler"
    - path: "src/__tests__/mcp-stdio.test.ts"
      provides: "Integration tests with copilot stub verifying CLI flags"
      contains: "createCopilotStub"
    - path: "src/__tests__/default-model.test.ts"
      provides: "Default model constant and env var override tests"
      contains: "DEFAULT_COPILOT_MODEL"
  key_links:
    - from: "src/__tests__/mcp-stdio.test.ts"
      to: "copilot binary stub"
      via: "PATH prepended with stub directory"
      pattern: "createCopilot.*Stub"
    - from: "src/__tests__/mcp-stdio.test.ts"
      to: "CLI flags verification"
      via: "captured-args.json read from stub output"
      pattern: "allow-all-tools"
    - from: "src/__tests__/index.test.ts"
      to: "toolHandlers registry"
      via: "import { toolHandlers } from '../tools/handlers.js'"
      pattern: "toolHandlers\\[TOOLS\\.ASK\\]"
---

<objective>
Rewrite the full test suite to cover the four new Copilot tool handlers and verify correct CLI flag passing. This plan brings the project to a fully green state: all tests pass, and the integration test confirms the copilot binary is invoked with the correct non-interactive flags.

Purpose: Establish test coverage for the rewritten handlers and provide regression protection for CLI-03 (all required flags) and CLI-02 (-p not -i).
Output: Rewritten test files; `npm test` passes with zero failures.
</objective>

<execution_context>
@/Users/jonathanborduas/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jonathanborduas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-cli-integration/01-RESEARCH.md
@.planning/phases/01-core-cli-integration/01-02-SUMMARY.md
@src/types.ts
@src/tools/handlers.ts
@src/tools/definitions.ts
@src/__tests__/mcp-stdio.test.ts
@src/__tests__/index.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite src/__tests__/index.test.ts for four Copilot tools</name>
  <files>
    src/__tests__/index.test.ts
    src/__tests__/error-scenarios.test.ts
    src/__tests__/edge-cases.test.ts
  </files>
  <action>
    **src/__tests__/index.test.ts — full rewrite:**

    Replace all existing content. The file must test:
    1. Tool handler existence: `toolHandlers[TOOLS.ASK]`, `toolHandlers[TOOLS.SUGGEST]`, `toolHandlers[TOOLS.EXPLAIN]`, `toolHandlers[TOOLS.PING]` all exist and have `execute` methods
    2. Tool definitions: `toolDefinitions` array has exactly 4 entries with names 'ask', 'suggest', 'explain', 'ping'
    3. PingToolHandler returns correct message without calling executeCommand
    4. AskToolHandler returns stdout content (mock executeCommand to return `{ stdout: 'Test Copilot response', stderr: '' }`)
    5. SuggestToolHandler with target='shell' constructs prompt containing "shell command"
    6. SuggestToolHandler with target='git' constructs prompt containing "git command"
    7. SuggestToolHandler with target='gh' constructs prompt containing "GitHub CLI (gh)"
    8. ExplainToolHandler wraps command in explain prompt
    9. AskToolHandler with addDir validates path — test that passing a non-absolute addDir throws ValidationError
    10. MCP schema compliance: each handler's result passes `CallToolResultSchema.safeParse()` from `@modelcontextprotocol/sdk/types.js`

    Mock pattern (preserve from existing codebase):
    ```typescript
    jest.mock('../utils/command.js', () => ({
      executeCommand: jest.fn(),
    }));
    jest.mock('chalk', () => ({
      default: { blue: (t: string) => t, yellow: (t: string) => t, green: (t: string) => t, red: (t: string) => t },
    }));
    ```

    For verifying prompt construction in SuggestToolHandler, capture the `executeCommand` mock call args and assert the prompt string (first arg after '-p') contains the correct text.

    **src/__tests__/error-scenarios.test.ts — rewrite to Copilot patterns:**
    Replace Codex-specific tests. New tests:
    1. AskToolHandler rejects when executeCommand rejects (e.g., non-zero exit code via strictExitCode) — mock `executeCommand` to reject with an Error, expect handler to throw `ToolExecutionError`
    2. SuggestToolHandler rejects with ToolExecutionError on command failure
    3. ExplainToolHandler rejects with ToolExecutionError on command failure
    4. AskToolHandler rejects with ValidationError when addDir contains null byte
    5. AskToolHandler rejects with ValidationError when addDir contains `../` traversal
    6. AskToolHandler rejects with ValidationError when addDir is not absolute (e.g., 'relative/path')
    7. extractResponse pattern: when stdout is empty and stderr is non-empty, handler throws ToolExecutionError (mock executeCommand to resolve with `{ stdout: '', stderr: 'quota error' }`)

    **src/__tests__/edge-cases.test.ts — rewrite to Copilot patterns:**
    Remove session-related edge cases. New tests:
    1. SuggestToolHandler with no target uses default prompt "Suggest a command to accomplish: ..."
    2. Model parameter is passed through to executeCommand args (verify '--model' in the call args)
    3. addDir parameter results in '--add-dir' in executeCommand call args
    4. COPILOT_DEFAULT_MODEL_ENV_VAR is used when model param is not provided
    5. Empty prompt string is accepted by Zod (it is a string; prompt length validation is not required by specs)
  </action>
  <verify>
    `npm test -- --testPathPattern="index|error-scenarios|edge-cases" 2>&1 | tail -5` — all three test files pass.
    `grep "CodexToolHandler\|session\|sessionId\|ReviewToolHandler\|HelpToolHandler\|ListSessions" src/__tests__/index.test.ts src/__tests__/error-scenarios.test.ts src/__tests__/edge-cases.test.ts` — zero results.
    `grep "AskToolHandler\|SuggestToolHandler\|ExplainToolHandler\|PingToolHandler" src/__tests__/index.test.ts` — all four found.
  </verify>
  <done>index.test.ts, error-scenarios.test.ts, and edge-cases.test.ts all pass; they cover all four handlers, addDir validation, prompt construction, and error propagation; no Codex references remain</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite mcp-stdio.test.ts with copilot stub and flag verification, update model tests</name>
  <files>
    src/__tests__/mcp-stdio.test.ts
    src/__tests__/model-selection.test.ts
    src/__tests__/default-model.test.ts
  </files>
  <action>
    **src/__tests__/mcp-stdio.test.ts — full rewrite (TEST-04):**

    This is the integration test that verifies CLI flags. Pattern from the research:

    ```typescript
    import { mkdtempSync, writeFileSync, chmodSync, readFileSync, existsSync } from 'fs';
    import { tmpdir } from 'os';
    import path from 'path';
    // ... MCP SDK imports for running the server and calling tools

    function createCopilotStub(captureArgs = false): { stubDir: string; argsFile?: string } {
      const stubDir = mkdtempSync(path.join(tmpdir(), 'copilot-mcp-test-'));
      const stubPath = path.join(stubDir, 'copilot');
      const argsFile = captureArgs ? path.join(stubDir, 'captured-args.json') : undefined;

      const stubScript = captureArgs
        ? `#!/bin/sh\nprintf '%s\\n' "$@" > ${argsFile}\nprintf "stub response from Copilot\\n"\nexit 0\n`
        : `#!/bin/sh\nprintf "stub response from Copilot\\n"\nexit 0\n`;

      writeFileSync(stubPath, stubScript);
      chmodSync(stubPath, 0o755);
      return { stubDir, argsFile };
    }
    ```

    Tests to write:
    1. **Tool list test**: Start the MCP server in-process (or via stdio), call ListToolsRequest, verify response contains tools: ask, suggest, explain, ping (exactly 4 tools, not 5).
    2. **Flag verification test (CLI-03)**: Use the flag-capturing stub. Call the `ask` tool via the server. Read captured-args.json. Assert the following strings appear in args: `--allow-all-tools`, `--no-ask-user`, `--silent`, `--no-color`, `--no-auto-update`.
    3. **-p flag test (CLI-02)**: Same capturing stub. Verify `-p` is in the captured args. Verify `-i` and `--interactive` are NOT in the captured args.
    4. **stdout response test (CLI-04)**: Use the non-capturing stub (returns "stub response from Copilot" to stdout). Call `ask` tool. Verify the response content text equals "stub response from Copilot".
    5. **Copilot binary name test (CLI-01)**: The stub is named `copilot` (not `gh`). The test confirms the server finds and calls the binary named `copilot`.

    For in-process server testing, follow the existing mcp-stdio.test.ts pattern. Prepend the stub directory to PATH: `process.env.PATH = \`${stubDir}:${process.env.PATH}\``. Restore PATH in afterEach/afterAll.

    Timeout: set Jest timeout to 15000ms for integration tests that spawn real processes.

    **src/__tests__/model-selection.test.ts — rewrite:**
    Remove Codex model tests. New tests:
    1. Passing `model: 'gpt-4o'` to AskToolHandler results in `--model gpt-4o` in executeCommand args
    2. Passing `model: 'claude-sonnet-4-5'` results in `--model claude-sonnet-4-5`
    3. Not passing model results in `--model gpt-4.1` (DEFAULT_COPILOT_MODEL)
    4. Model from COPILOT_DEFAULT_MODEL_ENV_VAR env var is used when model param is absent and env var is set

    Use mocked executeCommand (not the real copilot binary) for these unit-level tests.

    **src/__tests__/default-model.test.ts — rewrite:**
    ```typescript
    import { DEFAULT_COPILOT_MODEL, COPILOT_DEFAULT_MODEL_ENV_VAR } from '../types.js';

    describe('Default Copilot Model', () => {
      test('DEFAULT_COPILOT_MODEL is gpt-4.1', () => {
        expect(DEFAULT_COPILOT_MODEL).toBe('gpt-4.1');
      });

      test('COPILOT_DEFAULT_MODEL_ENV_VAR is COPILOT_DEFAULT_MODEL', () => {
        expect(COPILOT_DEFAULT_MODEL_ENV_VAR).toBe('COPILOT_DEFAULT_MODEL');
      });
    });
    ```
  </action>
  <verify>
    `npm test 2>&1 | tail -15` — ALL test files pass, zero failures.
    `npm test 2>&1 | grep -E "Tests:|Test Suites:"` — all suites green.
    `grep "allow-all-tools\|no-ask-user\|--silent\|no-color\|no-auto-update" src/__tests__/mcp-stdio.test.ts` — all five flags verified in assertions.
    `grep "\-p\b" src/__tests__/mcp-stdio.test.ts` — the -p flag check is present.
    `grep "codex\|Codex\|gh copilot\|sessionId" src/__tests__/mcp-stdio.test.ts` — zero results.
  </verify>
  <done>mcp-stdio.test.ts verifies copilot binary invocation with all required flags via a copilot shell stub; model-selection.test.ts and default-model.test.ts cover model parameter routing; npm test passes with all test suites green</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm test 2>&1 | grep "failed\|FAIL"` → zero results (all green)
2. `npm test 2>&1 | grep -E "Test Suites:.*passed"` → shows N passed, 0 failed
3. `ls src/__tests__/` → does NOT contain session.test.ts, resume-functionality.test.ts, context-building.test.ts
4. `grep "codex\|Codex\|CodexTool\|sessionId" src/__tests__/*.test.ts` → zero results
5. `grep "DEFAULT_COPILOT_MODEL.*gpt-4\.1" src/__tests__/default-model.test.ts` → found
6. `grep "allow-all-tools" src/__tests__/mcp-stdio.test.ts` → found in test assertions
</verification>

<success_criteria>
- npm test passes with zero failures across all test files
- Integration test (mcp-stdio.test.ts) proves the copilot binary is called with --allow-all-tools, --no-ask-user, --silent, --no-color, --no-auto-update, and -p (not -i)
- Unit tests cover all four handlers, addDir validation, prompt construction for suggest/explain, model parameter routing
- No Codex or session references remain in any test file
- Phase 1 is complete: all 17 requirements (TOOL-01 through TEST-04) are implemented and tested
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-cli-integration/01-03-SUMMARY.md` using the summary template. Note final test counts, list which tests cover which requirements, and confirm Phase 1 is complete.
</output>
